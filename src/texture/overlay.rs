use crate::image::ImageSize;
use std::{ops::Range, sync::Arc};

#[derive(Debug)]
pub struct Overlay {
    pub pixels: Vec<Range<u32>>,
    pub color: [u8; 4],
}

pub struct OverlayTexture {
    texture: wgpu::Texture,
    pub view: wgpu::TextureView,
    pub overlays: Arc<Vec<Overlay>>,
    size: wgpu::Extent3d,
}

impl OverlayTexture {
    pub fn new(image_size: &ImageSize, device: &wgpu::Device) -> Self {
        let size = wgpu::Extent3d {
            width: image_size.width.get(),
            height: image_size.height.get(),
            depth_or_array_layers: 1,
        };
        let texture = device.create_texture(&Self::desc(&size));
        let view = texture.create_view(&wgpu::TextureViewDescriptor::default());
        Self {
            texture,
            view,
            overlays: Arc::new(Vec::new()),
            size,
        }
    }

    pub fn set_overlays(&mut self, overlays: Arc<Vec<Overlay>>) {
        self.overlays = overlays;
    }

    pub fn write_to_queue(&self, queue: &wgpu::Queue) {
        let overlay_data = self.create_overlay_data();
        queue.write_texture(
            wgpu::TexelCopyTextureInfo {
                texture: &self.texture,
                mip_level: 0,
                origin: wgpu::Origin3d::ZERO,
                aspect: wgpu::TextureAspect::All,
            },
            &overlay_data,
            wgpu::TexelCopyBufferLayout {
                offset: 0,
                bytes_per_row: Some(self.size.width * 4),
                rows_per_image: Some(self.size.height),
            },
            self.size,
        );
    }

    /// Creates a texture data array where each pixel (u32 index) maps to an RGBA color
    /// Returns a vec where each 4 bytes represents RGBA for that pixel index
    /// If a pixel has no overlay, it's [0, 0, 0, 0]
    fn create_overlay_data(&self) -> Vec<u8> {
        let total_pixels = (self.size.width * self.size.height) as usize;
        let mut data = vec![0u8; total_pixels * 4];

        for overlay in self.overlays.iter() {
            for range in &overlay.pixels {
                for pixel_idx in range.start..range.end {
                    let idx = (pixel_idx as usize) * 4;
                    if idx + 3 < data.len() {
                        data[idx] = overlay.color[0];
                        data[idx + 1] = overlay.color[1];
                        data[idx + 2] = overlay.color[2];
                        data[idx + 3] = overlay.color[3];
                    }
                }
            }
        }
        data
    }

    fn desc(size: &wgpu::Extent3d) -> wgpu::TextureDescriptor<'static> {
        wgpu::TextureDescriptor {
            label: Some("overlay_texture"),
            size: *size,
            mip_level_count: 1,
            sample_count: 1,
            dimension: wgpu::TextureDimension::D2,
            format: wgpu::TextureFormat::Rgba8Unorm,
            usage: wgpu::TextureUsages::TEXTURE_BINDING | wgpu::TextureUsages::COPY_DST,
            view_formats: &[],
        }
    }
}

pub fn example_overlays() -> Vec<Overlay> {
    vec![
        Overlay {
            pixels: vec![
                52775..52786,
                53312..53333,
                53851..53878,
                54391..54422,
                54931..54966,
                55472..55509,
                56012..56053,
                56553..56569,
                56580..56596,
                57093..57107,
                57126..57140,
                57634..57647,
                57670..57683,
                58175..58187,
                58214..58226,
                58716..58727,
                58758..58769,
                59257..59268,
                59301..59312,
                59799..59808,
                59845..59854,
                60340..60349,
                60388..60397,
                60881..60890,
                60931..60940,
                61423..61431,
                61474..61482,
                61964..61972,
                62017..62025,
                62505..62514,
                62559..62568,
                63047..63055,
                63102..63110,
                63588..63596,
                63645..63653,
                64130..64138,
                64187..64195,
                64671..64679,
                64730..64738,
                65213..65221,
                65272..65280,
                65755..65762,
                65815..65822,
                66296..66304,
                66357..66365,
                66838..66845,
                66900..66907,
                67380..67387,
                67442..67449,
                67922..67929,
                67984..67991,
                68464..68471,
                68526..68533,
                69005..69012,
                69069..69076,
                69547..69554,
                69611..69618,
                70089..70096,
                70153..70160,
                70631..70638,
                70695..70702,
                71173..71180,
                71237..71244,
                71715..71722,
                71779..71786,
                72257..72264,
                72321..72328,
                72799..72806,
                72863..72870,
                73341..73348,
                73405..73412,
                73883..73890,
                73947..73954,
                74425..74432,
                74489..74496,
                74968..74975,
                75030..75037,
                75510..75517,
                75572..75579,
                76052..76059,
                76114..76121,
                76594..76601,
                76656..76663,
                77136..77144,
                77197..77205,
                77679..77686,
                77739..77746,
                78221..78229,
                78280..78288,
                78763..78771,
                78822..78830,
                79306..79314,
                79363..79371,
                79848..79856,
                79905..79913,
                80391..80399,
                80446..80454,
                80933..80942,
                80987..80996,
                81476..81484,
                81529..81537,
                82019..82027,
                82070..82078,
                82561..82570,
                82611..82620,
                83104..83113,
                83152..83161,
                83647..83656,
                83693..83702,
                84189..84200,
                84233..84244,
                84732..84743,
                84774..84785,
                85275..85287,
                85314..85326,
                85818..85831,
                85854..85867,
                86361..86375,
                86394..86408,
                86905..86921,
                86932..86948,
                87448..87489,
                87992..88029,
                88535..88570,
                89079..89110,
                89623..89650,
                90168..90189,
                90715..90726,
            ],
            color: [0, 255, 255, 200],
        },
        Overlay {
            pixels: vec![
                70123..70126,
                70664..70669,
                71205..71212,
                71747..71754,
                72289..72296,
                72832..72837,
                73375..73378,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139368..139371,
                139909..139914,
                140450..140457,
                140992..140999,
                141534..141541,
                142077..142082,
                142620..142623,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139625..139628,
                140166..140171,
                140707..140714,
                141249..141256,
                141791..141798,
                142334..142339,
                142877..142880,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                267652..267655,
                268193..268198,
                268734..268741,
                269276..269283,
                269818..269825,
                270361..270366,
                270904..270907,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                122020..122031,
                122557..122578,
                123096..123123,
                123636..123667,
                124176..124211,
                124717..124754,
                125257..125298,
                125798..125814,
                125825..125841,
                126338..126352,
                126371..126385,
                126879..126892,
                126915..126928,
                127420..127432,
                127459..127471,
                127961..127972,
                128003..128014,
                128502..128513,
                128546..128557,
                129044..129053,
                129090..129099,
                129585..129594,
                129633..129642,
                130126..130135,
                130176..130185,
                130668..130676,
                130719..130727,
                131209..131217,
                131262..131270,
                131750..131759,
                131804..131813,
                132292..132300,
                132347..132355,
                132833..132841,
                132890..132898,
                133375..133383,
                133432..133440,
                133916..133924,
                133975..133983,
                134458..134466,
                134517..134525,
                135000..135007,
                135060..135067,
                135541..135549,
                135602..135610,
                136083..136090,
                136145..136152,
                136625..136632,
                136687..136694,
                137167..137174,
                137229..137236,
                137709..137716,
                137771..137778,
                138250..138257,
                138314..138321,
                138792..138799,
                138856..138863,
                139334..139341,
                139398..139405,
                139876..139883,
                139940..139947,
                140418..140425,
                140482..140489,
                140960..140967,
                141024..141031,
                141502..141509,
                141566..141573,
                142044..142051,
                142108..142115,
                142586..142593,
                142650..142657,
                143128..143135,
                143192..143199,
                143670..143677,
                143734..143741,
                144213..144220,
                144275..144282,
                144755..144762,
                144817..144824,
                145297..145304,
                145359..145366,
                145839..145846,
                145901..145908,
                146381..146389,
                146442..146450,
                146924..146931,
                146984..146991,
                147466..147474,
                147525..147533,
                148008..148016,
                148067..148075,
                148551..148559,
                148608..148616,
                149093..149101,
                149150..149158,
                149636..149644,
                149691..149699,
                150178..150187,
                150232..150241,
                150721..150729,
                150774..150782,
                151264..151272,
                151315..151323,
                151806..151815,
                151856..151865,
                152349..152358,
                152397..152406,
                152892..152901,
                152938..152947,
                153434..153445,
                153478..153489,
                153977..153988,
                154019..154030,
                154520..154532,
                154559..154571,
                155063..155076,
                155099..155112,
                155606..155620,
                155639..155653,
                156150..156166,
                156177..156193,
                156693..156734,
                157237..157274,
                157780..157815,
                158324..158355,
                158868..158895,
                159413..159434,
                159960..159971,
            ],
            color: [0, 255, 255, 200],
        },
        Overlay {
            pixels: vec![
                70123..70126,
                70664..70669,
                71205..71212,
                71747..71754,
                72289..72296,
                72832..72837,
                73375..73378,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139368..139371,
                139909..139914,
                140450..140457,
                140992..140999,
                141534..141541,
                142077..142082,
                142620..142623,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139625..139628,
                140166..140171,
                140707..140714,
                141249..141256,
                141791..141798,
                142334..142339,
                142877..142880,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                267652..267655,
                268193..268198,
                268734..268741,
                269276..269283,
                269818..269825,
                270361..270366,
                270904..270907,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                122277..122288,
                122814..122835,
                123353..123380,
                123893..123924,
                124433..124468,
                124974..125011,
                125514..125555,
                126055..126071,
                126082..126098,
                126595..126609,
                126628..126642,
                127136..127149,
                127172..127185,
                127677..127689,
                127716..127728,
                128218..128229,
                128260..128271,
                128759..128770,
                128803..128814,
                129301..129310,
                129347..129356,
                129842..129851,
                129890..129899,
                130383..130392,
                130433..130442,
                130925..130933,
                130976..130984,
                131466..131474,
                131519..131527,
                132007..132016,
                132061..132070,
                132549..132557,
                132604..132612,
                133090..133098,
                133147..133155,
                133632..133640,
                133689..133697,
                134173..134181,
                134232..134240,
                134715..134723,
                134774..134782,
                135257..135264,
                135317..135324,
                135798..135806,
                135859..135867,
                136340..136347,
                136402..136409,
                136882..136889,
                136944..136951,
                137424..137431,
                137486..137493,
                137966..137973,
                138028..138035,
                138507..138514,
                138571..138578,
                139049..139056,
                139113..139120,
                139591..139598,
                139655..139662,
                140133..140140,
                140197..140204,
                140675..140682,
                140739..140746,
                141217..141224,
                141281..141288,
                141759..141766,
                141823..141830,
                142301..142308,
                142365..142372,
                142843..142850,
                142907..142914,
                143385..143392,
                143449..143456,
                143927..143934,
                143991..143998,
                144470..144477,
                144532..144539,
                145012..145019,
                145074..145081,
                145554..145561,
                145616..145623,
                146096..146103,
                146158..146165,
                146638..146646,
                146699..146707,
                147181..147188,
                147241..147248,
                147723..147731,
                147782..147790,
                148265..148273,
                148324..148332,
                148808..148816,
                148865..148873,
                149350..149358,
                149407..149415,
                149893..149901,
                149948..149956,
                150435..150444,
                150489..150498,
                150978..150986,
                151031..151039,
                151521..151529,
                151572..151580,
                152063..152072,
                152113..152122,
                152606..152615,
                152654..152663,
                153149..153158,
                153195..153204,
                153691..153702,
                153735..153746,
                154234..154245,
                154276..154287,
                154777..154789,
                154816..154828,
                155320..155333,
                155356..155369,
                155863..155877,
                155896..155910,
                156407..156423,
                156434..156450,
                156950..156991,
                157494..157531,
                158037..158072,
                158581..158612,
                159125..159152,
                159670..159691,
                160217..160228,
            ],
            color: [0, 255, 255, 200],
        },
        Overlay {
            pixels: vec![
                70123..70126,
                70664..70669,
                71205..71212,
                71747..71754,
                72289..72296,
                72832..72837,
                73375..73378,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139368..139371,
                139909..139914,
                140450..140457,
                140992..140999,
                141534..141541,
                142077..142082,
                142620..142623,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139625..139628,
                140166..140171,
                140707..140714,
                141249..141256,
                141791..141798,
                142334..142339,
                142877..142880,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                267652..267655,
                268193..268198,
                268734..268741,
                269276..269283,
                269818..269825,
                270361..270366,
                270904..270907,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                250304..250315,
                250841..250862,
                251380..251407,
                251920..251951,
                252460..252495,
                253001..253038,
                253541..253582,
                254082..254098,
                254109..254125,
                254622..254636,
                254655..254669,
                255163..255176,
                255199..255212,
                255704..255716,
                255743..255755,
                256245..256256,
                256287..256298,
                256786..256797,
                256830..256841,
                257328..257337,
                257374..257383,
                257869..257878,
                257917..257926,
                258410..258419,
                258460..258469,
                258952..258960,
                259003..259011,
                259493..259501,
                259546..259554,
                260034..260043,
                260088..260097,
                260576..260584,
                260631..260639,
                261117..261125,
                261174..261182,
                261659..261667,
                261716..261724,
                262200..262208,
                262259..262267,
                262742..262750,
                262801..262809,
                263284..263291,
                263344..263351,
                263825..263833,
                263886..263894,
                264367..264374,
                264429..264436,
                264909..264916,
                264971..264978,
                265451..265458,
                265513..265520,
                265993..266000,
                266055..266062,
                266534..266541,
                266598..266605,
                267076..267083,
                267140..267147,
                267618..267625,
                267682..267689,
                268160..268167,
                268224..268231,
                268702..268709,
                268766..268773,
                269244..269251,
                269308..269315,
                269786..269793,
                269850..269857,
                270328..270335,
                270392..270399,
                270870..270877,
                270934..270941,
                271412..271419,
                271476..271483,
                271954..271961,
                272018..272025,
                272497..272504,
                272559..272566,
                273039..273046,
                273101..273108,
                273581..273588,
                273643..273650,
                274123..274130,
                274185..274192,
                274665..274673,
                274726..274734,
                275208..275215,
                275268..275275,
                275750..275758,
                275809..275817,
                276292..276300,
                276351..276359,
                276835..276843,
                276892..276900,
                277377..277385,
                277434..277442,
            ],
            color: [0, 255, 255, 200],
        },
        Overlay {
            pixels: vec![
                70123..70126,
                70664..70669,
                71205..71212,
                71747..71754,
                72289..72296,
                72832..72837,
                73375..73378,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139368..139371,
                139909..139914,
                140450..140457,
                140992..140999,
                141534..141541,
                142077..142082,
                142620..142623,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                139625..139628,
                140166..140171,
                140707..140714,
                141249..141256,
                141791..141798,
                142334..142339,
                142877..142880,
            ],
            color: [255, 0, 0, 200],
        },
        Overlay {
            pixels: vec![
                267652..267655,
                268193..268198,
                268734..268741,
                269276..269283,
                269818..269825,
                270361..270366,
                270904..270907,
            ],
            color: [255, 0, 0, 200],
        },
    ]
}
